@model ChatApp.Models.AppUser
@using Microsoft.AspNetCore.Identity
@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager
@{
    ViewData["Title"] = "Home Page";
}

@if (!SignInManager.IsSignedIn(User))
{
    <div class="text-center">
        <h1 class="display-4">Welcome to my chat application.</h1>
        <p>
            This website allows users to create an account and chat with other users in real time.<br />
            The register and login features use ASP.NET Identity<br />
            SignalR is used to allow users to send and recieve messages in real time.<br />
            Users can search for chatrooms to join, or create their own chatrooms and add disired users to the chatroom.<br />
            The creator of a chatroom is the admin and can perform various actions on the chatroom.
        </p>
        <h4>Please Register and/or Login to continue</h4>
    </div>
}
else
{
    <!--Create Chatroom Popup-->
    <div class="modal fade bg-dark bg-transparent" id="newChatroomModal" tabindex="-1" role="dialog" aria-labelledby="newChatroomModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Create New Chatroom</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span class="text-white" aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!--validate input
                        check chatroom name length
                        check if members exist
                        autocomplete member textbox
                            dont show current user
                        change submit functionality
                            onclick
                                call ajax post function
                                    calls create chatroom json result controller method
                                        creates chatroom
                                        adds members to chatroom
                                        returns chatroom including members as json
                                        calls function to add chatroom to chatroom list
                                        calls function to display chatroom-->
                    <form id="createChatroomForm" asp-action="CreateChatroom" method="post">
                        <div class="row justify-content-center">
                            <label>Public</label>
                            <input id="isPublic" name="isPublic" type="radio" style="margin-right: 15px; margin-left: 5px;" value="Public">
                            <label>Private</label>
                            <input id="isPublic" name="isPublic" type="radio" style="margin-left: 5px;" value="Private">
                        </div>
                        <div class="row justify-content-center">
                            <input type="text" name="chatroomName" class="bg-dark text-white" style="border-radius: 10px;" placeholder="Chatroom Name" />
                        </div>
                        <div class="row justify-content-center">
                            <input type="text" id="txtSearchUsers" name="username" class="bg-dark text-white" style="border-radius: 10px; margin-top:10px;" placeholder="Chatroom member" />
                        </div>
                        <div id="addMemberBtn" class="row justify-content-center">
                            <button type="button" class="btn btn-link" onclick="AddNewTextBox()">Add another member</button>
                        </div>
                        <div class="row justify-content-center">
                            <input id="createChatroomBtn" type="submit" class="btn btn-primary" value="Create" />
                            <button type="button" class="btn btn-secondary offset-1" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!--Chatroom List
        search/join chatrooms autocomplete
            only display chatroom if current user isn't already a member of chatroom or if they are blocked
            onclick ajax post function
                call add join chatroom json result controller method
                    gets chatroom including members messages and senders
                    adds current user to members
                    return chatroom as json
                    calls function to add chatroom to chatroom list
                    calls function to display chatroom
        add new messages tag
            add timestamp to AppUserChatroom table-->
    <div class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-4 col-xl-3 chat">
                <div class="card mb-sm-3 mb-md-0 contacts_card">
                    <div class="card-header">
                        <div class="input-group">
                            <input id="txtSearchChatrooms" type="text" placeholder="Search Chatrooms..." name="" class="form-control search">
                        </div>
                    </div>
                    <div class="card-body contacts_body">
                        <ui class="contacts">
                            @foreach (Chatroom room in Model.Chatrooms)
                            {
                                <li>
                                    <!--add bottom border to each list item
                                            call display chatroom function
                                            pass chatroom id and user id to function
                                            set this.className = "active"
                                            get chatroom by id
                                                include messages
                                                theninclude sender
                                            display chatroom name, message count, member count
                                            create and display messages foreach message
                                                set message classname depending on UserId-->
                                    <div class="d-flex bd-highlight">
                                        <div class="user_info col-11">
                                            <div class="row col-12">
                                                <span id="chatroom-name">@room.ChatroomName</span>
                                            </div>
                                            @if (room.Messages.Count > 0)
                                            {
                                                <p id="message-text-preview">@room.Messages[room.Messages.Count - 1].Text</p>
                                                <p>@room.Messages[room.Messages.Count - 1].Sent</p>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ui>
                    </div>
                    <div class="card-footer text-center">
                        <button type="button" class="btn btn-primary rounded-pill" style="border-radius: 40px;" data-toggle="modal" data-target="#newChatroomModal">Create new chatroom</button>
                    </div>
                </div>
            </div>
            <!--Chatroom
                invite users should only show up if chatroom is public or if user is admin and chatroom is private
                    onclick display modal to enter usernames
                    autocomplete usernames
                        dont show current user or any users who are already members or blocked users
                block user is only available to admin
                    create blocked field in AppUserChatroom table
                unblock user only available to admin
                delete chatroom is only available to admin
                    deleter chatroom and all messages (test for cascade delete)
                leave chatroom is available to everyone
                    remove current user from chatroom-->
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="user_info">
                                <span>Chatroom name</span>
                                <p style="margin-bottom: 0;">1767 Messages</p>
                                <p>10 Members</p>
                            </div>
                        </div>
                        <span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>
                        <div class="action_menu">
                            <ul>
                                <li><i class="fas fa-users"></i> Invite users</li>
                                <li><i class="fas fa-ban"></i> Block user</li>
                                <li><i class="fas fa-trash"></i> Delete chatroom</li>
                                <li><i class="fas fa-sign-out-alt"></i> Leave chatroom</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body msg_card_body">
                        <div class="d-flex justify-content-start mb-4">
                            <div class="msg_cotainer">
                                Hi, how are you samim?
                                <span class="msg_time">Sender Name 8:40 AM, Today</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mb-4">
                            <div class="msg_cotainer_send">
                                Hi Khalid i am good tnx how about you?
                                <span class="msg_time_send">8:55 AM, Today</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <textarea name="" class="form-control type_msg" placeholder="Type your message..."></textarea>
                            <div class="input-group-append">
                                <span class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<!--set url to navigate to when joining a chatroom
<script type="text/javascript">
    var url = 'Url.Action("GoToChatroom", "ChatroomList", new { chatroomId =  "id"})';
</script>
-->
